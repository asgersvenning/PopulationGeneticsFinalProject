---
title: "Exploratory Analysis"
author: "Asger Svenning"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
  theme: cayman
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(magrittr)
library(tidyverse) %>% 
  suppressPackageStartupMessages()
library(ggforce)
library(patchwork)
library(ggnewscale)
library(extrafont)
library(ggpubr)
library(kableExtra)
library(bit)
library(progress)
library(conflicted)
c("symdiff", "xor") %>% 
  sapply(function(x) conflict_prefer(x, "bit", quiet = T)) %>% 
  invisible()
c("group_rows", "filter", "select") %>% 
  sapply(function(x) conflict_prefer(x, "dplyr", quiet = T)) %>% 
  invisible()
c("set_names", "set_colnames", "set_rownames", "extract") %>% 
  sapply(function(x) conflict_prefer(x, "magrittr", quiet = T)) %>% 
  invisible()
c("expand", "pack", "unpack") %>% 
  sapply(function(x) conflict_prefer(x, "tidyr", quiet = T)) %>% 
  invisible()

source("IOUHelpers.R")

knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE, 
  fig.width = 8, 
  fig.height = 8, 
  cache = T, 
  dev.args = list(png = list(type = "cairo"))
)

theme_set(
  theme_pubr(legend = "right", base_family = "CMU Serif") +
    theme(title = element_text(face = "bold",
                               size = 14),
          strip.text = element_text(face = "bold",
                                    size = 14),
          plot.title = element_text(face = "plain",
                                    size = 20,
                                    hjust = .5),
          aspect.ratio = 1)
)
```

# Import data
Filter lengths for positive lengths, since negative lengths are impossible. Negative lengths are probably present due to underflow in the bioinformatics pipeline prior to this analysis.
```{r}
arch <- read_delim("ArchaicSegments.txt", delim = "\t") %>% 
  filter(length > 0) %>% 
  mutate(country = str_extract(country, "[\\w ]+")) %>% 
  nest(all = !c(region, country)) %>% 
  group_by(country) %>% 
  mutate(
    country = paste0(country, rep("_", n()), region),
    country = if (n() == 1) str_remove(country, "_.+") else country
  ) %>% 
  ungroup() %>% 
  unnest(all) %>% 
  filter(length > 0) %>% 
  mutate(chrom = factor(chrom, unique(chrom)[order(as.numeric(unique(chrom)))])) %>% 
  filter(chrom == "2" & between(start, 46293667-10^6, 46386697+10^6) & between(end, 46293667-10^6, 46386697+10^6))

init_plts <- arch %>% 
  summarize(across(everything(), list)) %>% 
  pivot_longer(everything(), names_to = "variable") %>% 
  mutate(
    plt = map2(variable, value, function(n, x) {
      x <- unlist(x)
      pl <- if (is.numeric(x)) {
        tibble(x = x) %>% 
          ggplot(aes(x)) +
          geom_histogram(bins = 100) +
          coord_cartesian(expand = F)
      }
      else {
        nunique <- length(unique(x))
        tibble(x = x) %>% 
          ggplot(aes(y = x)) +
          geom_bar() +
          scale_x_continuous(expand = expansion()) +
          scale_y_discrete(
            labels = if (nunique > 20) function(x) replace(x, which(!(1:length(x) %in% floor(seq(1, length(x), length.out = 20)))), "") else function(x) x
          )
      }
      
      pl +
        theme(plot.margin = margin(0,0,.2,.2, "cm")) +
        labs(title  = n, x = NULL, y = NULL)
    })
  )
```

## Initial visualization of data variable distributions
```{r, fig.height = 20, fig.width=15}
init_plts %>% 
  pull(plt) %>% 
  wrap_plots(ncol = 3)
```

## Which populations are overrepresented
```{r}
arch %>% 
  count(pop) %>% 
  arrange(desc(n)) %>% 
  slice_head(n = 5) %>% 
  kable %>% 
  kable_material(full_width = F)
```

# Questions

## To what extent do individuals share SNPs contributed by archaic human introgression? In other words, how correlated are the archaic contents in two individuals?

In order to do this analyses we first check if the segments align, which would simplify the analyses significantly.
```{r, fig.height=8, fig.width=16}
arch %>% 
  # filter(chrom == 1) %>% 
  # filter(start < 4*10^6) %>% 
  # group_by(pop) %>% 
  # filter(n() > 10) %>% 
  ggplot(aes(start - length/2, name, width = length, fill = MeanProb)) +
  geom_tile(height = 1) +
  scale_fill_viridis_c(trans = "log10", option = "A") +
  # facet_wrap(~pop, ncol = 3, switch = "y", scales = "free_y") +
  labs(x = "Genomic Position", y = "Individual", title = "Archaic Segments in a small\npart of Chromosome 1") +
  theme(aspect.ratio = .5,
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

Since the segments do not overlap we have to somehow efficiently measure their degree of similarity, the most na√Øve method would be to index would be a distance metric calculated between binary vectors of archaic/modern state for each position in e.g. a chromosome. An intuitive distance measure between such vectors would be the intersection over union, also called the Jaccard Index:

$$d(x,y)=\frac{\sum\mathbf{1}_{x = 1\;\land\; y = 1}}{\sum\mathbf{1}_{x = 1\;\lor\; y = 1}}$$
Which can be efficiently calculated using bitwise boolean operations. However we will still expect this to be prohibitive due to the memory footprint of binary vectors the size of the human genome. We therefore opt to approximate the binary archaic state vectors by dividing the indices of the archaic fragments by a relatively large constant (400) and randomly rounding it (un-biased rounding). By doing this we are able to reduce the memory usage by several orders of magnitude while not sacrificing much in terms of precision. Here we have focused on chromosome 1 somewhat arbitrarily 
```{r}
all_chrom_range <- arch %>%
  group_by(chrom) %>% 
  summarize(
    start = min(start),
    end = max(end),
    .groups = "drop"
  ) %>% 
  arrange(chrom) %>% 
  mutate(
    length = end - start,
    offset = lag(cumsum(length), default = 0) #- first(length)
  )

all_chrom_summary <- all_chrom_range %>% 
  summarize(across(!chrom, ~list(set_names(.x, chrom)))) %>% 
  as.list %>% 
  lapply(first)

all_chrom_range %>% 
  mutate(across(c(start, end), ~.x - start + 1 + offset)) %>% 
  mutate(chrom = as.integer(chrom)) %>%
  mutate(nchrom = lead(chrom),
         nstart = lead(start)) %>% 
  ggplot() +
  geom_segment(aes(chrom, start, xend = chrom, yend = end)) +
  geom_segment(aes(chrom, end, xend = nchrom, yend = nstart)) +
  scale_x_continuous(labels = levels(all_chrom_range$chrom), breaks = 1:length(levels(all_chrom_range$chrom)))


arch_approx <- arch %>% 
  # group_by(chrom) %>% 
  # mutate(across(c(start, end), ~.x - all_chrom_summary$start[first(chrom)] + all_chrom_summary$offset[first(chrom)] + 1)) %>%
  # mutate(across(c(start, end), ~randomRound(.x/4000))) %>%
  mutate(length = end - start) %>% 
  filter(length > 0)
```


```{r}
x_chrom_end_range <- arch_approx %>%
  pull(end) %>% 
  range

x_chrom_start_range <- arch_approx %>% 
  pull(start) %>% 
  range

x_chrom_min <- x_chrom_start_range[1]
x_chrom_max <- x_chrom_end_range[2] - x_chrom_min + 1

arch_approx <- arch_approx %>%
  mutate(across(c(start, end), ~.x - x_chrom_min + 1))

arch_persons <- arch_approx %>% 
  group_by(name, pop, country, region) %>% 
  summarize(
    prs = list(person(start, end, x_chrom_max)),
    .groups = "drop"
  ) %>% 
  mutate(prs = prs %>% 
           set_names(name))

country_sample_1_dmat <- arch_persons %>% 
  group_by(region, country) %>%
  slice_sample(n = 1) %>% 
  ungroup %>% 
  person_pairwise_dist_df("prs", "name")

country_to_region <- arch %>% 
  distinct(country, region) %>% 
  {
    set_names(.$region, .$country)
  }

library(ggnewscale)
country_sample_1_dmat %>%
  arrange(region_1, country_1) %>% 
  mutate(country_1 = factor(country_1, levels = unique(country_1)),
         country_2 = factor(country_2, levels = levels(country_1))) %>% 
  ggplot(aes(country_1, country_2,fill=iou)) +
  geom_tile() +
  scale_fill_viridis_c(trans = "log10", option = "A", na.value = "white", direction = -1,
                       name = "1 - IoU", labels = scales::label_percent()) +
  new_scale_fill() +
  geom_tile(
    aes(last(pop), pop, fill = region),
    data = tibble(pop = names(country_to_region),
                  region = unname(country_to_region)) %>%
      arrange(region) %>% 
      mutate(pop = factor(pop, unique(pop))),
    inherit.aes = F,
    position = position_nudge(x = 1),
    key_glyph = draw_key_point
  ) +
  scale_fill_manual(values = c("firebrick3", "magenta2", "cyan3", "darkorchid3", "darkolivegreen3"),
                    name = "Region") +
  guides(fill = guide_legend(override.aes = list(shape = 21,
                                                 size = 15))) +
  scale_x_discrete(expand = expansion(0, c(0, 1))) +
  scale_y_discrete(expand = expansion()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_rect(fill = "gray65"),
        legend.key.height = unit(3.5, "lines"),
        legend.key.width = unit(4, "lines"),
        legend.text = element_text(size = 16),
        legend.title = element_text(hjust = .5,
                                    size = 24),
        legend.box = "horizontal")
```

## Within population variation
```{r}
within_pop_iou <- arch_persons %>% 
  nest(persons = !c(pop, country, region)) %>% 
  arrange(country) %>% 
  filter(map_dbl(persons, nrow) > 2) %>% 
  mutate(
    mean_iou = map_dbl(persons, function(x) {
      persons <- x$prs %>% 
        lapply(function(y) do.call(encode_binary_vector, y))
      n_persons <- 0
      sum_iou <- 0
      for (i in 1:length(persons)) {
        persons_i <- persons[[i]]
        for (j in 1:length(persons)) {
          if (i <= j) next
          sum_iou <- sum_iou + bit_vec_iou(persons_i, persons[[j]])
          n_persons <- n_persons + 1
        }
      }
      sum_iou / n_persons
    }),
    n = map_dbl(persons, nrow)
  )

within_pop_iou %>%
  ggplot(aes(mean_iou, pop, color = country, label = n)) +
  geom_point() +
  geom_label(aes(x = .25)) +
  facet_wrap(~region, scales = "free_y", ncol = 1) +
  theme(aspect.ratio = .2)
```

```{r}
all_dmat <- arch_persons %>%
  person_pairwise_dist_df("prs", "name")
```

```{r}
### Create plot
skip_labels <- function(n) function(x) replace(x, which(!(1:length(x) %in% floor(seq(1, length(x), length.out = n)))), "")

prs_to_country <- all_dmat %>% 
  distinct(country_1, prs_1) %>% 
  {set_names(.$country_1, .$prs_1)}

label_prs_to_country <- function(prs) {
  country <- prs_to_country[prs] %>% 
    unname
  
  country_boundary_ind <- c(1, which(country[1:(length(country) - 1)] != country[2:length(country)]))
  
  country_center_ind <- country_boundary_ind + 
    (c(country_boundary_ind, length(country)) %>% 
       diff %>% 
       divide_by(2) %>% 
       ceiling)
  
  country[-country_center_ind] <- "" # str_extract(country[-country_center_ind], ".")
  # cat(paste0(country, collapse = "\n"))
  country
}

all_dmat_plt <- all_dmat %>% 
  # filter(country_1 == "Papua" & country_2 == "Papua") %>% 
  arrange(region_1, country_1, pop_1, prs_1) %>%  
  mutate(
    country_1 = factor(country_1, unique(country_1)) %>% 
      fct_shuffle,
    country_2 = factor(country_2, levels(country_1)),
    prs_1 = factor(prs_1, unique(prs_1)),
    prs_2 = factor(prs_2, levels(prs_1))
  ) %>% 
  mutate(iou = ifelse(prs_1 == prs_2, NA, iou)) %>% 
  ggplot(aes(prs_1, prs_2, fill = iou, color = iou)) +
  geom_tile() +
  scale_fill_viridis_c(#trans = "log10",
    option = "A",
    direction = -1,
    na.value = "gray75",
    labels = scales::label_percent(),
    name = "1 - IoU") +
  scale_colour_viridis_c(#trans = "log10",
    option = "A",
    direction = -1,
    na.value = "gray75",
    labels = scales::label_percent()) +
  new_scale_fill() +
  geom_tile(aes(x = -4.5, y = ifelse(as.integer(prs_1) == 1, prs_2, NA), fill = as.integer(country_2), color = after_scale(fill)),
            width = 10,
            show.legend = F) +
  geom_tile(aes(y = -4.5, x = ifelse(as.integer(prs_2) == 1, prs_1, NA), fill = as.integer(country_1), color = after_scale(fill)),
            height = 10,
            show.legend = F) +
  scale_fill_distiller(palette = "Greys") +
  scale_x_discrete(labels = label_prs_to_country, expand = expansion(0, c(10, 0))) +
  scale_y_discrete(labels = label_prs_to_country, expand = expansion(0, c(10, 0))) +
  coord_equal() +
  guides(colour = guide_none()) +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_text(hjust = 1,
                                   angle = 90,
                                   vjust = .1),
        axis.text.y = element_text(vjust = .1),
        axis.text = element_text(size = 6),
        axis.title = element_blank(),
        legend.title = element_text(hjust = .5,
                                    size = 20),
        legend.text = element_text(size = 14),
        legend.key.width = unit(2, "lines"),
        legend.key.height = unit(4, "lines"))

# all_dmat_plt
ggsave("all_dmat.png", all_dmat_plt,
       width = 16, height = 16, dpi = 400, scale = .5)
```


```{r}
all_dmat %>% 
    mutate(prs_1 = factor(prs_1),
           prs_2 = factor(prs_2, levels = levels(prs_1))) %>% 
    filter(as.integer(prs_1) < as.integer(prs_2)) %>% 
    group_by(same_region = region_1 == region_2, region_1, region_2) %>% 
    summarize(
        iou = mean(iou)
    ) %>% 
    ggplot(aes(region_1, region_2, fill = iou)) +
    geom_tile() +
    scale_fill_viridis_c(option = "A",
                         direction = -1) +
    coord_equal(expand = F) +
    labs(fill = "1 - IoU") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title = element_blank(),
          legend.title = element_text(hjust = .5,
                                      size = 20),
          legend.text = element_text(size = 14),
          legend.key.width = unit(2, "lines"),
          legend.key.height = unit(4, "lines"))
```

```{r}
all_dmat %>% 
  arrange(region_1) %>% 
    mutate(prs_1 = factor(prs_1),
           prs_2 = factor(prs_2, levels = levels(prs_1)),
           country_1 = factor(country_1, unique(country_1)),
           country_2 = factor(country_2, levels(country_1))) %>%
    group_by(same_country = country_1 == country_2, country_1, country_2) %>% 
    summarize(
        iou = mean(iou[prs_1 != prs_2]),
        .groups = "drop"
    ) %>% 
  complete(country_1, country_2, fill = list(iou = NA)) %>% 
    ggplot(aes(country_1, country_2, fill = iou)) +
    geom_tile() +
    scale_fill_viridis_c(option = "A",
                         na.value = "gray75",
                         direction = -1) +
    coord_equal(expand = F) +
    labs(fill = "1 - IoU") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25),
          axis.title = element_blank(),
          legend.title = element_text(hjust = .5,
                                      size = 20),
          legend.text = element_text(size = 14),
          legend.key.width = unit(2, "lines"),
          legend.key.height = unit(4, "lines"))
```

```{r}
arch_meta <- arch_persons %>% 
  select(name, pop, country, region) %>% 
  arrange(region) %>% 
  mutate(country = factor(country, unique(country)))

all_t_dmat <- all_dmat %>% 
  arrange(country_1, country_2) %>% 
  mutate(
    prs_1 = factor(prs_1, unique(prs_1)),
    prs_2 = factor(prs_2, levels(prs_1))
  ) %>% 
  # filter(region_1 != "Melanesia" & region_2 != "Melanesia") %>% 
  select(prs_1, prs_2, iou) %>%
  pivot_wider(id_cols = prs_1, names_from = prs_2, values_from = iou) %>%
  set_rownames(.$prs_1) %>%
  select(!prs_1) %>% 
  as.matrix %>% 
  as.dist

all_tree <- all_t_dmat %>% 
  hclust("ward.D2")  

all_cluster <- cutree(all_tree, 6) %>% 
  {
    tibble(label = names(.),
           cluster = unname(.))
  }

as_tbl_graph(all_tree) %>% 
  left_join(all_cluster) %>% 
  left_join(arch_meta, by = c(label = "name")) %>% 
  ggraph() +
  geom_edge_elbow(
    position = position_nudge(y = .1)
  ) +
  geom_node_tile(aes(fill = factor(cluster), width = leaf),
                 height = .05,
                 color = "transparent") +
  scale_fill_brewer(palette = "Set1") +
  new_scale_fill() +
  geom_node_tile(aes(fill = country, width = leaf),
                 height = .05,
                 color = "transparent",
                 position = position_nudge(y = .1))
```

```{r}
all_t_dmat %>% 
  # princomp %>% 
  # extract2("scores") %>% 
  # as.data.frame() %>% 
  # rownames_to_column("prs") %>% 
  umap() %>%
  as.data.frame() %>%
  set_colnames(c("U1", "U2")) %>%
  rownames_to_column("prs") %>%
  as_tibble() %>% 
  left_join(arch_meta, by = c(prs = "name")) %>% 
  ggplot(aes(U1, U2, color = region)) +
  geom_point(size = 3) +
  theme(aspect.ratio = 1)
```

```{r}
all_dmat %>% 
    rename_with(function(x) str_replace(x, "prs", "name")) %>% 
    left_join(arch_persons %>% 
                  select(name, prs), by = c(name_1 = "name")) %>% 
    rename("prs_1" = "prs") %>% 
    left_join(arch_persons %>% 
                  select(name, prs), by = c(name_2 = "name")) %>% 
    rename("prs_2" = "prs") %>% 
    mutate(
        across(contains("prs"), ~map_int(.x, function(x) {
            sum(x$end - x$start)
        }))
    ) %>% 
    mutate(
        mean_len = prs_1/2 + prs_2/2
    ) %>% 
    ggplot(aes(mean_len, iou)) +
    geom_bin2d() +
    geom_smooth(method = mgcv::bam, formula = y ~ s(x),
                family.args = list(family = "quasibinomial")) +
    scale_fill_viridis_c(trans = "log10", option = "A") +
    coord_cartesian(expand = F)
```


